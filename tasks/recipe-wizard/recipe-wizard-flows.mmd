%% Essential Oil Recipe Wizard MVP - Comprehensive Flow Diagrams
%% Three interconnected flows: User Flow, Data Flow, and AI Agent Flow

graph TB
    %% ===========================================
    %% 1. USER FLOW DIAGRAM - 6-Step Wizard Progression
    %% ===========================================
    
    subgraph UserFlow ["ğŸ§­ User Flow - 6-Step Wizard Progression"]
        direction TB
        
        %% Step 1: Health Concern Input
        U1[ğŸ‘¤ User enters health concern]
        U1_Component["ğŸ“„ health-concern-input.tsx<br/>Chat-style interface"]
        U1_Validation{Minimum 3 characters?}
        U1_Error["âŒ Show validation error"]
        
        %% Step 2: Demographics
        U2[ğŸ‘¤ User provides demographics]
        U2_Component["ğŸ“„ demographics-form.tsx<br/>Gender, Age Category, Specific Age"]
        U2_Validation{All fields complete?}
        U2_Error["âŒ Show form errors"]
        
        %% Step 3: Potential Causes (AI-Powered)
        U3[ğŸ¤– AI generates potential causes]
        U3_Component["ğŸ“„ causes-selection.tsx<br/>Multi-select interface"]
        U3_Selection{User selects causes?}
        U3_Error["âŒ Agent failure fallback"]

        %% Step 4: Symptoms (AI-Powered)
        U4[ğŸ¤– AI generates symptoms]
        U4_Component["ğŸ“„ symptoms-selection.tsx<br/>Multi-select interface"]
        U4_Selection{User selects symptoms?}
        U4_Error["âŒ Agent failure fallback"]

        %% Step 5: Therapeutic Properties (AI-Powered)
        U5[ğŸ¤– AI analyzes properties]
        U5_Component["ğŸ“„ properties-display.tsx<br/>Display properties information"]
        U5_Continue{Continue to oils?}
        U5_Error["âŒ Agent failure fallback"]

        %% Step 6: Suggested Oils (AI-Powered)
        U6[ğŸ¤– AI suggests oils]
        U6_Component["ğŸ“„ oils-display.tsx<br/>Display oil recommendations"]
        U6_Complete[âœ… Wizard Complete]
        U6_Error["âŒ Agent failure fallback"]
        
        %% Navigation Controls
        Nav_Back["â¬…ï¸ navigation-controls.tsx<br/>Previous Step"]
        Nav_Next["â¡ï¸ navigation-controls.tsx<br/>Next Step"]
        Progress["ğŸ“Š progress-indicator.tsx<br/>Step tracking with agent status"]
        
        %% User Flow Connections
        U1 --> U1_Component --> U1_Validation
        U1_Validation -->|No| U1_Error --> U1
        U1_Validation -->|Yes| U2
        
        U2 --> U2_Component --> U2_Validation
        U2_Validation -->|No| U2_Error --> U2
        U2_Validation -->|Yes| U3
        
        U3 --> U3_Component --> U3_Selection
        U3_Selection -->|No selection| U3_Error --> U3
        U3_Selection -->|Selected| U4
        
        U4 --> U4_Component --> U4_Selection
        U4_Selection -->|No selection| U4_Error --> U4
        U4_Selection -->|Selected| U5
        
        U5 --> U5_Component --> U5_Continue
        U5_Continue -->|Error| U5_Error --> U5
        U5_Continue -->|Continue| U6
        
        U6 --> U6_Component --> U6_Complete
        U6 -->|Error| U6_Error --> U6
        
        %% Navigation Integration
        Nav_Back -.->|Available Steps 2-6| U1
        Nav_Next -.->|Validation passed| U2
        Progress -.->|Track all steps| U6_Complete
    end
    
    %% ===========================================
    %% 2. DATA FLOW DIAGRAM - System Data Movement
    %% ===========================================
    
    subgraph DataFlow ["ğŸ’¾ Data Flow - System Data Movement"]
        direction TB
        
        %% Frontend State Management
        subgraph Frontend ["ğŸ–¥ï¸ Frontend Layer"]
            WizardStore["ğŸ“¦ wizard-store.ts<br/>Zustand State Management"]
            SessionStorage["ğŸ’¾ Session Storage<br/>Persistence & Recovery"]
            UserContext["ğŸ‘¤ User Context<br/>Health concern + Demographics"]
        end
        
        %% API Layer
        subgraph APILayer ["ğŸ”Œ API Layer"]
            APIRoute["ğŸ“¡ /api/recipe-wizard/analyze<br/>route.ts - Enhanced handler"]
            RequestValidation{Request Validation<br/>Zod schemas}
            ResponseValidation{Response Validation<br/>Safety + Research data}
        end
        
        %% Service Layer
        subgraph ServiceLayer ["âš™ï¸ Service Layer"]
            AgentOrchestrator["ğŸ¯ agent-orchestrator.ts<br/>Specialized agent coordination"]
            PromptManager["ğŸ“ prompt-manager.ts<br/>YAML configuration loader"]
        end

        %% Data Flow Connections
        WizardStore <--> SessionStorage
        WizardStore --> UserContext
        UserContext --> APIRoute
        APIRoute --> RequestValidation
        RequestValidation -->|Valid| AgentOrchestrator
        RequestValidation -->|Invalid| ResponseValidation

        AgentOrchestrator --> PromptManager
        AgentOrchestrator --> ResponseValidation
        ResponseValidation --> APIRoute
        APIRoute --> WizardStore
    end

    %% ===========================================
    %% 3. AI AGENT FLOW DIAGRAM - Specialized Agent Orchestration
    %% ===========================================

    subgraph AgentFlow ["ğŸ¤– AI Agent Flow - Specialized Agent Orchestration"]
        direction TB

        %% Agent Selection Logic
        AgentSelector{ğŸ¯ Agent Selection<br/>Based on wizard step}

        %% Specialized Agents (Feature-specific)
        subgraph SpecializedAgents ["ğŸ§  Specialized Agents (src/features/recipe-wizard/services/agents/)"]

            subgraph MedicalAgent ["ğŸ¥ Medical Analysis Agent"]
                MA_Agent["medical-analysis-agent.ts<br/>Temperature: 0.3 (Conservative)"]
                MA_Prompt["ğŸ“„ potential-causes.yaml<br/>Medical analysis prompt"]
                MA_Response["ğŸ“‹ Potential Causes Response"]
            end

            subgraph SymptomAgent ["ğŸ” Symptom Correlation Agent"]
                SC_Agent["symptom-correlation-agent.ts<br/>Temperature: 0.4 (Moderate)"]
                SC_Prompt["ğŸ“„ potential-symptoms.yaml<br/>Symptom correlation prompt"]
                SC_Response["ğŸ“‹ Symptoms Response"]
            end

            subgraph PropertiesAgent ["âš—ï¸ Therapeutic Properties Agent"]
                TP_Agent["therapeutic-properties-agent.ts<br/>Temperature: 0.2 (Accurate)"]
                TP_Prompt["ğŸ“„ therapeutic-properties.yaml<br/>Properties analysis prompt"]
                TP_Response["ğŸ“‹ Properties Response"]
            end

            subgraph OilAgent ["ğŸŒ¿ Oil Recommendation Agent"]
                OR_Agent["oil-recommendation-agent.ts<br/>Temperature: 0.5 (Balanced)"]
                OR_Prompt["ğŸ“„ suggested-oils.yaml<br/>Oil recommendation prompt"]
                OR_Response["ğŸ“‹ Oil Suggestions Response"]
            end
        end

        %% YAML Prompt Processing
        subgraph PromptProcessing ["ğŸ“ YAML Prompt Processing"]
            YAMLLoader["ğŸ“‚ YAML File Loader<br/>js-yaml parser"]
            TemplateProcessor["ğŸ”„ Template Processor<br/>Variable substitution"]
            ConfigExtractor["âš™ï¸ Config Extractor<br/>Temperature, tools, schema"]
        end

        %% OpenAI Agents JS SDK Integration
        subgraph OpenAISDK ["ğŸ”Œ OpenAI Agents JS SDK Integration"]
            AgentExecution["ğŸš€ Agent Execution<br/>OpenAI Agents JS SDK"]
            StructuredOutput["ğŸ“Š Structured Output<br/>JSON schema validation"]
            ErrorHandling["âŒ Error Handling<br/>Retry with temperature adjustment"]
        end

        %% Agent Flow Connections
        AgentSelector -->|Step 3: Causes| MedicalAgent
        AgentSelector -->|Step 4: Symptoms| SymptomAgent
        AgentSelector -->|Step 5: Properties| PropertiesAgent
        AgentSelector -->|Step 6: Oils| OilAgent

        %% Medical Agent Flow
        MA_Agent --> MA_Prompt --> YAMLLoader
        YAMLLoader --> TemplateProcessor --> ConfigExtractor
        ConfigExtractor --> AgentExecution --> MA_Response

        %% Symptom Agent Flow
        SC_Agent --> SC_Prompt --> YAMLLoader
        AgentExecution --> SC_Response

        %% Properties Agent Flow
        TP_Agent --> TP_Prompt --> YAMLLoader
        AgentExecution --> TP_Response

        %% Oil Agent Flow
        OR_Agent --> OR_Prompt --> YAMLLoader
        AgentExecution --> OR_Response

        %% Error Handling
        AgentExecution -->|Failure| ErrorHandling
        ErrorHandling -->|Retry| AgentExecution
        ErrorHandling -->|Fallback| StructuredOutput

        %% Structured Output Processing
        MA_Response --> StructuredOutput
        SC_Response --> StructuredOutput
        TP_Response --> StructuredOutput
        OR_Response --> StructuredOutput
    end

    %% ===========================================
    %% INTERCONNECTIONS BETWEEN FLOWS
    %% ===========================================

    %% User Flow to Data Flow Connections
    U3 -.->|Triggers API call| APIRoute
    U4 -.->|Triggers API call| APIRoute
    U5 -.->|Triggers API call| APIRoute
    U6 -.->|Triggers API call| APIRoute

    %% Data Flow to Agent Flow Connections
    AgentOrchestrator -.->|Selects agent| AgentSelector
    StructuredOutput -.->|Returns response| ResponseValidation

    %% Agent Flow to User Flow Connections
    MA_Response -.->|Displays causes| U3_Component
    SC_Response -.->|Displays symptoms| U4_Component
    TP_Response -.->|Displays properties| U5_Component
    OR_Response -.->|Displays oils| U6_Component

    %% ===========================================
    %% ERROR HANDLING & FALLBACK MECHANISMS
    %% ===========================================

    subgraph ErrorHandlingFlow ["âŒ Error Handling & Fallback Mechanisms"]
        direction TB

        %% Error Boundary Components
        ErrorBoundary["ğŸ›¡ï¸ error-boundary.tsx<br/>Agent-specific error handling"]

        %% Fallback Strategies
        subgraph FallbackStrategies ["ğŸ”„ Fallback Strategies"]
            AgentFallback["ğŸ¤– Agent Fallback<br/>General agent if specialized fails"]
            CachedResponse["ğŸ’¾ Cached Response<br/>Previous successful responses"]
            GracefulDegradation["â¬‡ï¸ Graceful Degradation<br/>Basic functionality maintained"]
        end

        %% Error Types
        subgraph ErrorTypes ["âš ï¸ Error Types"]
            NetworkError["ğŸŒ Network Error<br/>API unavailable"]
            AgentError["ğŸ¤– Agent Error<br/>OpenAI SDK failure"]
            ValidationError["ğŸ“‹ Validation Error<br/>Invalid response format"]
            ToolError["ğŸ”§ Tool Error<br/>External API failure"]
        end

        %% Error Handling Connections
        NetworkError --> CachedResponse
        AgentError --> AgentFallback
        ValidationError --> ErrorBoundary
        ToolError --> GracefulDegradation

        ErrorBoundary --> FallbackStrategies
        FallbackStrategies -.->|Recovery| UserFlow
    end

    %% ===========================================
    %% BARREL FILE IMPORT RELATIONSHIPS
    %% ===========================================

    subgraph ImportRelationships ["ğŸ“¦ Barrel File Import Relationships"]
        direction LR

        %% Agents Barrel
        AgentsBarrel["ğŸ“„ src/features/recipe-wizard/services/agents/index.ts<br/>export { MedicalAnalysisAgent, SymptomCorrelationAgent, ... }"]

        %% Import Usage
        OrchestratorImports["ğŸ”— Orchestrator Imports<br/>import { MedicalAnalysisAgent } from './agents'"]

        %% Import Relationships
        AgentsBarrel --> OrchestratorImports
        OrchestratorImports -.->|Used by| AgentOrchestrator
    end

    %% ===========================================
    %% STATE TRANSITIONS & DATA PERSISTENCE
    %% ===========================================

    subgraph StateTransitions ["ğŸ”„ State Transitions & Data Persistence"]
        direction TB

        %% State Management
        StateManager["ğŸ“Š State Manager<br/>wizard-store.ts (Zustand)"]

        %% State Transitions
        subgraph Transitions ["ğŸ”„ State Transitions"]
            StepTransition["â¡ï¸ Step Transition<br/>Forward navigation with validation"]
            BackwardNav["â¬…ï¸ Backward Navigation<br/>Data preservation + clearing subsequent steps"]
            SessionRecovery["ğŸ”„ Session Recovery<br/>Automatic state restoration"]
        end

        %% Data Persistence
        subgraph Persistence ["ğŸ’¾ Data Persistence"]
            LocalStorage["ğŸ’¾ Local Storage<br/>Session data persistence"]
            ContextPreservation["ğŸ‘¤ Context Preservation<br/>User data + agent results"]
            CacheManagement["ğŸ—„ï¸ Cache Management<br/>Agent responses + external tool data"]
        end

        %% State Flow Connections
        StateManager --> Transitions
        StateManager --> Persistence
        StepTransition -.->|Updates| WizardStore
        BackwardNav -.->|Clears data| WizardStore
        SessionRecovery -.->|Restores| UserContext

        LocalStorage <--> WizardStore
        ContextPreservation <--> UserContext
        CacheManagement <--> AgentOrchestrator
    end

    %% ===========================================
    %% PERFORMANCE & MONITORING
    %% ===========================================

    subgraph PerformanceMonitoring ["ğŸ“ˆ Performance & Monitoring"]
        direction TB

        %% Performance Metrics
        subgraph Metrics ["ğŸ“Š Performance Metrics"]
            AgentResponseTime["â±ï¸ Agent Response Time<br/>< 2 seconds per agent"]
            UserCompletion["ğŸ‘¤ User Completion<br/>Funnel analysis by step"]
        end

        %% Monitoring Integration
        subgraph Monitoring ["ğŸ“¡ Monitoring Integration"]
            ErrorTracking["âŒ Error Tracking<br/>Agent-specific error rates"]
            PerformanceTracking["ğŸ“ˆ Performance Tracking<br/>Response time optimization"]
        end

        %% Monitoring Connections
        SpecializedAgents -.->|Metrics| AgentResponseTime
        UserFlow -.->|Metrics| UserCompletion

        ErrorHandlingFlow -.->|Data| ErrorTracking
        AgentFlow -.->|Data| PerformanceTracking
    end
